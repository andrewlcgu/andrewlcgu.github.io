<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>深入了解Handler以及相关问题 | Andrewlcgu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="总体介绍 深入分析 Handler内存泄露问题 一种优雅的解决方案 参考   根据Google官方，Handler机制有两个主要作用:1.在未来某个时刻调度消息执行;2.在其他线程中执行相关操作。实际上，我们可以看成是framework层提供的一种线程之间通信方式。通常，我们与UI线程交互时会使用Handler实现,本文主要讨论其源码实现以及相关问题。 总体介绍 事件驱动模型 Looper,M">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="深入了解Handler以及相关问题">
<meta property="og:url" content="http://yoursite.com/2016/04/17/handler-research/index.html">
<meta property="og:site_name" content="Andrewlcgu&#39;s Blog">
<meta property="og:description" content="总体介绍 深入分析 Handler内存泄露问题 一种优雅的解决方案 参考   根据Google官方，Handler机制有两个主要作用:1.在未来某个时刻调度消息执行;2.在其他线程中执行相关操作。实际上，我们可以看成是framework层提供的一种线程之间通信方式。通常，我们与UI线程交互时会使用Handler实现,本文主要讨论其源码实现以及相关问题。 总体介绍 事件驱动模型 Looper,M">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2016/04/17/handler-research/handler_outline.png">
<meta property="og:image" content="http://yoursite.com/2016/04/17/handler-research/message_class_pic.png">
<meta property="og:image" content="http://yoursite.com/2016/04/17/handler-research/handler_rebuildEpollLocked.png">
<meta property="og:image" content="http://yoursite.com/2016/04/17/handler-research/handler_send_message.png">
<meta property="og:image" content="http://yoursite.com/2016/04/17/handler-research/handler_native_poll_once.png">
<meta property="og:updated_time" content="2016-04-17T10:00:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入了解Handler以及相关问题">
<meta name="twitter:description" content="总体介绍 深入分析 Handler内存泄露问题 一种优雅的解决方案 参考   根据Google官方，Handler机制有两个主要作用:1.在未来某个时刻调度消息执行;2.在其他线程中执行相关操作。实际上，我们可以看成是framework层提供的一种线程之间通信方式。通常，我们与UI线程交互时会使用Handler实现,本文主要讨论其源码实现以及相关问题。 总体介绍 事件驱动模型 Looper,M">
<meta name="twitter:image" content="http://yoursite.com/2016/04/17/handler-research/handler_outline.png">
  
    <link rel="alternative" href="/atom.xml" title="Andrewlcgu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
</html>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/assets/potrait.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">andrewlcgu</a></h1>
		</hgroup>

		
		<p class="header-subtitle">人生如梦</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/categories/read-note">读书笔记</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/about">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/andrewlcgu" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/gu-lian-chao" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="mailto:andrewlcgu@foxmail.com" title="mail">mail</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android学习笔记/" style="font-size: 15px;">Android学习笔记</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Socket/" style="font-size: 15px;">Socket</a> <a href="/tags/理论知识/" style="font-size: 10px;">理论知识</a> <a href="/tags/算法与数据结构/" style="font-size: 15px;">算法与数据结构</a> <a href="/tags/纪念日/" style="font-size: 10px;">纪念日</a> <a href="/tags/读书笔记/" style="font-size: 10px;">读书笔记</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">andrewlcgu</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/assets/potrait.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">andrewlcgu</h1>
			</hgroup>
			
			<p class="header-subtitle">人生如梦</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/categories/read-note">读书笔记</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/about">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/andrewlcgu" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/gu-lian-chao" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:andrewlcgu@foxmail.com" title="mail">mail</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-handler-research" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/17/handler-research/" class="article-date">
  	<time datetime="2016-04-17T09:22:52.000Z" itemprop="datePublished">2016-04-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入了解Handler以及相关问题
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Andorid学习笔记/">Andorid学习笔记</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
           
             <div id="toc" class="article-toc">
             <h2>目录</h2>
               <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#总体介绍"><span class="toc-text">总体介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#深入分析"><span class="toc-text">深入分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handler内存泄露问题"><span class="toc-text">Handler内存泄露问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一种优雅的解决方案"><span class="toc-text">一种优雅的解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
             </div>
             <script type="text/javascript">
               var _article = document.getElementsByClassName('article')[0];
               setTimeout("_article.className += ' article2'",0);
               setTimeout("document.getElementById('toc').style.right = '15px'", 0);
             </script>
           
         
        <!-- toc -->
<ul>
<li><a href="#&#x603B;&#x4F53;&#x4ECB;&#x7ECD;">&#x603B;&#x4F53;&#x4ECB;&#x7ECD;</a></li>
<li><a href="#&#x6DF1;&#x5165;&#x5206;&#x6790;">&#x6DF1;&#x5165;&#x5206;&#x6790;</a></li>
<li><a href="#handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;">Handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;</a></li>
<li><a href="#&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;">&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;</a></li>
<li><a href="#&#x53C2;&#x8003;">&#x53C2;&#x8003;</a></li>
</ul>
<!-- tocstop -->
<p>&#x6839;&#x636E;Google&#x5B98;&#x65B9;&#xFF0C;Handler&#x673A;&#x5236;&#x6709;&#x4E24;&#x4E2A;&#x4E3B;&#x8981;&#x4F5C;&#x7528;:1.&#x5728;&#x672A;&#x6765;&#x67D0;&#x4E2A;&#x65F6;&#x523B;&#x8C03;&#x5EA6;&#x6D88;&#x606F;&#x6267;&#x884C;;2.&#x5728;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x6210;&#x662F;framework&#x5C42;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x901A;&#x4FE1;&#x65B9;&#x5F0F;&#x3002;&#x901A;&#x5E38;&#xFF0C;&#x6211;&#x4EEC;&#x4E0E;UI&#x7EBF;&#x7A0B;&#x4EA4;&#x4E92;&#x65F6;&#x4F1A;&#x4F7F;&#x7528;Handler&#x5B9E;&#x73B0;,&#x672C;&#x6587;&#x4E3B;&#x8981;&#x8BA8;&#x8BBA;&#x5176;&#x6E90;&#x7801;&#x5B9E;&#x73B0;&#x4EE5;&#x53CA;&#x76F8;&#x5173;&#x95EE;&#x9898;&#x3002;</p>
<h2 id="&#x603B;&#x4F53;&#x4ECB;&#x7ECD;"><a href="#&#x603B;&#x4F53;&#x4ECB;&#x7ECD;" class="headerlink" title="&#x603B;&#x4F53;&#x4ECB;&#x7ECD;"></a>&#x603B;&#x4F53;&#x4ECB;&#x7ECD;</h2><ul>
<li>&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x6A21;&#x578B;</li>
<li>Looper,Message&#x548C;Hanlder&#x5173;&#x7CFB;&#x56FE;</li>
</ul>
<img src="/2016/04/17/handler-research/handler_outline.png">
<ul>
<li>Looper&#x7C7B;<br>&#x7528;&#x4E8E;&#x5EFA;&#x7ACB;&#x6D88;&#x606F;&#x5FAA;&#x73AF;&#x5E76;&#x7BA1;&#x7406;&#x6D88;&#x606F;&#x961F;&#x5217;(MessageQueue),&#x4E0D;&#x505C;&#x7684;&#x4ECE;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4E2D;&#x62BD;&#x53D6;&#x6D88;&#x606F;,&#x5206;&#x53D1;&#x6267;&#x884C;&#x3002;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;Looper&#x5BF9;&#x8C61;,&#x5E76;&#x4E14;Looper&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x662F;&#x79C1;&#x6709;&#x7684;,&#x53EA;&#x662F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;MessageQueue&#x5BF9;&#x8C61;&#x5E76;&#x6301;&#x6709;&#x3002;&#x6839;&#x636E;Google&#x5B98;&#x65B9;&#x6587;&#x6863;,&#x4E00;&#x4E2A;Thread&#x5B9E;&#x73B0;Looper&#x673A;&#x5236;&#x5982;&#x4E0B;:<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class LooperThread extends Thread {</span><br><span class="line">    public Handler mHandler;</span><br><span class="line">  </span><br><span class="line">    public void run() {</span><br><span class="line">        Looper.prepare();</span><br><span class="line">  </span><br><span class="line">        mHandler = new Handler() {</span><br><span class="line">            public void handleMessage(Message msg) {</span><br><span class="line">                // process incoming messages here</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">  </span><br><span class="line">        Looper.loop();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>prepare()&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF0C;&#x5176;&#x4E2D;sThreadLocal&#x662F;&#x9759;&#x6001;&#x7684;TLS&#x5BF9;&#x8C61;&#x3002;&#x542F;&#x52A8;&#x4E00;&#x4E2A;Looper&#x673A;&#x5236;&#x7684;&#x7EBF;&#x7A0B;&#x5C3D;&#x91CF;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;HandlerThread&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void prepare() {</span><br><span class="line">    prepare(true);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">private static void prepare(boolean quitAllowed) {</span><br><span class="line">    if (sThreadLocal.get() != null) {</span><br><span class="line">        throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);</span><br><span class="line">    }</span><br><span class="line">    sThreadLocal.set(new Looper(quitAllowed));</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>loop()&#x5173;&#x952E;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x6574;&#x4F53;&#x6D41;&#x7A0B;&#x5C31;&#x662F;&#x62FF;&#x5230;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;Looper&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x4ECE;Looper&#x5BF9;&#x8C61;&#x7684;MessageQueue&#x53D6;Message&#xFF0C;&#x6267;&#x884C;&#xFF0C;&#x6700;&#x540E;&#x56DE;&#x6536;&#x6D88;&#x606F;&#x5BF9;&#x8C61;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static void loop() {</span><br><span class="line">    final Looper me = myLooper();</span><br><span class="line">    if (me == null) {</span><br><span class="line">        throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;);</span><br><span class="line">    }</span><br><span class="line">    final MessageQueue queue = me.mQueue;</span><br><span class="line">    ...</span><br><span class="line">    for (;;) {</span><br><span class="line">        Message msg = queue.next(); // might block</span><br><span class="line">        ...</span><br><span class="line">        msg.target.dispatchMessage(msg);  </span><br><span class="line">        ...</span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Message&#x7C7B;  </li>
</ul>
<img src="/2016/04/17/handler-research/message_class_pic.png">  
<p>Message&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x4E86;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x6C60;&#x6982;&#x5FF5;&#xFF0C;&#x4F7F;&#x7528;Message&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x4ECE;&#x6C60;&#x4E2D;&#x53D6;&#x5BF9;&#x8C61;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x94FE;&#x8868;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static Message obtain() {</span><br><span class="line">    synchronized (sPoolSync) {</span><br><span class="line">        if (sPool != null) {</span><br><span class="line">            Message m = sPool;</span><br><span class="line">            sPool = m.next;</span><br><span class="line">            m.next = null;</span><br><span class="line">            m.flags = 0; // clear in-use flag</span><br><span class="line">            sPoolSize--;</span><br><span class="line">            return m;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    return new Message();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Handler&#x7C7B;<br>&#x6700;&#x57FA;&#x672C;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5982;&#x4E0B;,&#x6700;&#x91CD;&#x8981;&#x7684;&#x5C31;&#x662F;&#x62FF;&#x5230;&#x5BF9;&#x5E94;&#x7EBF;&#x7A0B;&#x7684;Looper&#x548C;&#x5176;&#x4E2D;&#x7684;MessageQueue.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Handler(Callback callback, boolean async) {</span><br><span class="line">    ...</span><br><span class="line">    mLooper = Looper.myLooper(); // &#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;Looper&#x5BF9;&#x8C61;</span><br><span class="line">    if (mLooper == null) {</span><br><span class="line">        throw new RuntimeException(</span><br><span class="line">            &quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;);</span><br><span class="line">    }</span><br><span class="line">    mQueue = mLooper.mQueue;    // &#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span><br><span class="line">    mCallback = callback;       // Handler.Callback &#x63A5;&#x53E3;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&#x5176;&#x4E2D;&#xFF0C;CallBack&#x5B9A;&#x4E49;&#x5982;&#x4E0B;:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Callback {</span><br><span class="line">    public boolean handleMessage(Message msg);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x53D1;&#x9001;&#x6D88;&#x606F;api&#x6709;&#x4E24;&#x79CD;:sendXXX&#x548C;postXXX&#xFF0C;&#x5176;&#x4E2D;postXXX&#x90FD;&#x662F;&#x628A;Runnable&#x5BF9;&#x8C61;&#x5C01;&#x88C5;&#x5230;Message&#x5BF9;&#x8C61;&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;sendXXX&#x65B9;&#x6CD5;&#x3002;<br>Runnable&#x5305;&#x88C5;&#x6210;Message&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static Message getPostMessage(Runnable r) {</span><br><span class="line">    Message m = Message.obtain();</span><br><span class="line">    m.callback = r;</span><br><span class="line">    return m;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>sendXXX&#x65B9;&#x6CD5;&#x6700;&#x7EC8;&#x628A;Message&#x653E;&#x5230;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x5173;&#x952E;&#x662F;enqueueMessage()&#x51FD;&#x6570;&#xFF0C;&#x6700;&#x7EC8;&#x662F;&#x8C03;&#x7528;MessageQueue&#x4E2D;&#x65B9;&#x6CD5;&#x628A;&#x8BE5;Message&#x6309;&#x65F6;&#x95F4;&#x987A;&#x5E8F;&#x63D2;&#x5165;&#x961F;&#x5217;&#x4E2D;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {</span><br><span class="line">    msg.target = this; // &#x5173;&#x952E;&#x4EE3;&#x7801;&#xFF1A;&#x6D88;&#x606F;&#x7684;target&#x4E3A;Handler&#x5BF9;&#x8C61;&#xFF0C;&#x6700;&#x7EC8;&#x6D88;&#x606F;&#x5904;&#x7406;&#x662F;Handler&#x5B9E;&#x73B0;&#x7684;&#x3002;</span><br><span class="line">    if (mAsynchronous) {</span><br><span class="line">        msg.setAsynchronous(true);</span><br><span class="line">    }</span><br><span class="line">    return queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x6700;&#x7EC8;&#x5904;&#x7406;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void dispatchMessage(Message msg) {</span><br><span class="line">    if (msg.callback != null) {                    // 1. Message&#x5BF9;&#x8C61;&#x7684;Runnable</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    } else {</span><br><span class="line">        if (mCallback != null) {                   // 2. Handler.Callback &#x5BF9;&#x8C61;</span><br><span class="line">            if (mCallback.handleMessage(msg)) {</span><br><span class="line">                return;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        handleMessage(msg);                        // 3. Handler&#x672C;&#x8EAB;HandleMessage()&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;override</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h2 id="&#x6DF1;&#x5165;&#x5206;&#x6790;"><a href="#&#x6DF1;&#x5165;&#x5206;&#x6790;" class="headerlink" title="&#x6DF1;&#x5165;&#x5206;&#x6790;"></a>&#x6DF1;&#x5165;&#x5206;&#x6790;</h2><ul>
<li>MessageQueue&#x7C7B;<br>&#x8FD9;&#x4E2A;&#x7C7B;&#x6BD4;&#x8F83;&#x7279;&#x6B8A;,&#x7FFB;&#x770B;&#x6E90;&#x7801;&#x4F1A;&#x53D1;&#x73B0;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x4E86;&#x672C;&#x5730;&#x65B9;&#x6CD5;nativeInit,&#x5728;&#x672C;&#x5730;&#x4EE3;&#x7801;&#x4E2D;&#x4E3A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;&#x5185;&#x5B58;,&#x5B9E;&#x9645;&#x4E0A;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x5728;Native&#x5C42;&#x4E5F;&#x641E;&#x4E86;&#x4E00;&#x5957;Handler&#x673A;&#x5236;&#xFF0C;&#x901A;&#x8FC7;MessageQueue&#x8054;&#x7CFB;&#x5728;&#x4E00;&#x8D77;&#x3002;&#x67E5;&#x770B;&#x5BF9;&#x5E94;&#x6E90;&#x7801;&#x5982;&#x4E0B;&#xFF1A;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NativeMessageQueue::NativeMessageQueue() :</span><br><span class="line">        mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) {</span><br><span class="line">    mLooper = Looper::getForThread();</span><br><span class="line">    if (mLooper == NULL) {</span><br><span class="line">        mLooper = new Looper(false);</span><br><span class="line">        Looper::setForThread(mLooper);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&#x5DEE;&#x4E0D;&#x591A;&#x4EFF;&#x7167;Java&#x7684;&#x6837;&#x5B50;&#x641E;&#x4E86;&#x4E00;&#x4E2A;Looper,&#x770B;&#x4E00;&#x4E0B;Looper&#x6784;&#x9020;&#x51FD;&#x6570;&#x600E;&#x4E48;&#x5199;&#x7684;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Looper::Looper(bool allowNonCallbacks) :</span><br><span class="line">        mAllowNonCallbacks(allowNonCallbacks), mSendingMessage(false),</span><br><span class="line">        mPolling(false), mEpollFd(-1), mEpollRebuildRequired(false),</span><br><span class="line">        mNextRequestSeq(0), mResponseIndex(0), mNextMessageUptime(LLONG_MAX) {</span><br><span class="line">    mWakeEventFd = eventfd(0, EFD_NONBLOCK | EFD_CLOEXEC);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mWakeEventFd &lt; 0, &quot;Could not make wake event fd: %s&quot;,</span><br><span class="line">                        strerror(errno));</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    rebuildEpollLocked();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>Android6.0&#x4E4B;&#x524D;&#x4F7F;&#x7528;pipe,6.0&#x6539;&#x7528;eventfd,&#x76F8;&#x6BD4;&#x4E8E;pipe,eventfd&#x7F13;&#x5B58;&#x5927;&#x5C0F;&#x786E;&#x5B9A;&#x4E3A;8Byte,&#x8D1F;&#x8D23;&#x7EBF;&#x7A0B;&#x901A;&#x4FE1;&#x3002;&#x770B;&#x4E00;&#x4E0B;rebuildEpollLocked&#x51FD;&#x6570;:</p>
<img src="/2016/04/17/handler-research/handler_rebuildEpollLocked.png">  
<p>&#x5230;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x731C;&#x6D4B;&#xFF0C;&#x5E95;&#x5C42;&#x4F7F;&#x7528;epoll&#x673A;&#x5236;&#x5B9E;&#x73B0;:&#x6709;&#x65B0;&#x6D88;&#x606F;&#x65F6;&#x5524;&#x9192;Looper&#x7EBF;&#x7A0B;&#x8BFB;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x5426;&#x5219;&#x963B;&#x585E;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x770B;&#x6E90;&#x7801;&#x6765;&#x9A8C;&#x8BC1;&#xFF1A;  </p>
<p><strong> a) &#x53D1;&#x6D88;&#x606F; </strong>  </p>
<img src="/2016/04/17/handler-research/handler_send_message.png">  
<p>nativeWake&#x8C03;&#x7528;&#x4E86;Looper::wake&#x51FD;&#x6570;&#xFF0C;&#x5982;&#x4E0B;:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void Looper::wake() {</span><br><span class="line">#if DEBUG_POLL_AND_WAKE</span><br><span class="line">    ALOGD(&quot;%p ~ wake&quot;, this);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    uint64_t inc = 1;</span><br><span class="line">    ssize_t nWrite = TEMP_FAILURE_RETRY(write(mWakeEventFd, &amp;inc, sizeof(uint64_t)));</span><br><span class="line">    if (nWrite != sizeof(uint64_t)) {</span><br><span class="line">        if (errno != EAGAIN) {</span><br><span class="line">            ALOGW(&quot;Could not write wake signal: %s&quot;, strerror(errno));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5F80;mWakeEventFd&#x5199;&#x4E1C;&#x897F;&#x4E86;&#xFF01;&#x80AF;&#x5B9A;&#x5524;&#x9192;Looper&#x7EBF;&#x7A0B;&#x53D6;&#x6D88;&#x606F;&#x4E86;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x3002;  </p>
<p><strong> b) &#x53D6;&#x6D88;&#x606F; </strong>  </p>
<p>&#x4E3B;&#x8981;&#x662F;MessageQueue&#x7684;next()&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6709;&#x70B9;&#x590D;&#x6742;&#xFF0C;&#x6311;&#x91CD;&#x70B9;&#x8BF4;&#x4E00;&#x4E0B;:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Message next() {</span><br><span class="line">        ...</span><br><span class="line">        int pendingIdleHandlerCount = -1; // -1 only during first iteration</span><br><span class="line">        int nextPollTimeoutMillis = 0;</span><br><span class="line">        for (;;) {</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            // 1. &#x5173;&#x952E;&#x4EE3;&#x7801;:</span><br><span class="line">            nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">            synchronized (this) {</span><br><span class="line">                // Try to retrieve the next message.  Return if found.</span><br><span class="line">                final long now = SystemClock.uptimeMillis();</span><br><span class="line">                Message prevMsg = null;</span><br><span class="line">                Message msg = mMessages;</span><br><span class="line">                if (msg != null &amp;&amp; msg.target == null) {</span><br><span class="line">                    // Stalled by a barrier.  Find the next asynchronous message in the queue.</span><br><span class="line">                    do {</span><br><span class="line">                        prevMsg = msg;</span><br><span class="line">                        msg = msg.next;</span><br><span class="line">                    } while (msg != null &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">                }</span><br><span class="line">                if (msg != null) {</span><br><span class="line">                    if (now &lt; msg.when) {</span><br><span class="line">                        // Next message is not ready.  Set a timeout to wake up when it is ready.</span><br><span class="line">                        nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                    } else {</span><br><span class="line">                        // Got a message.</span><br><span class="line">                        mBlocked = false;</span><br><span class="line">                        if (prevMsg != null) {</span><br><span class="line">                            prevMsg.next = msg.next;</span><br><span class="line">                        } else {</span><br><span class="line">                            mMessages = msg.next;</span><br><span class="line">                        }</span><br><span class="line">                        msg.next = null;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg);</span><br><span class="line">                        msg.markInUse();</span><br><span class="line">                        return msg;</span><br><span class="line">                    }</span><br><span class="line">                } else {</span><br><span class="line">                    // No more messages.</span><br><span class="line">                    nextPollTimeoutMillis = -1;</span><br><span class="line">                }</span><br><span class="line">                ...</span><br><span class="line">            }</span><br><span class="line">            // 2. &#x5173;&#x952E;&#x4EE3;&#x7801;: </span><br><span class="line">            // Run the idle handlers.</span><br><span class="line">            // We only ever reach this code block during the first iteration.</span><br><span class="line">            for (int i = 0; i &lt; pendingIdleHandlerCount; i++) {</span><br><span class="line">                final IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">                mPendingIdleHandlers[i] = null; // release the reference to the handler</span><br><span class="line"></span><br><span class="line">                boolean keep = false;</span><br><span class="line">                try {</span><br><span class="line">                    keep = idler.queueIdle();</span><br><span class="line">                } catch (Throwable t) {</span><br><span class="line">                    Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                if (!keep) {</span><br><span class="line">                    synchronized (this) {</span><br><span class="line">                        mIdleHandlers.remove(idler);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></table></figure></p>
<p>1.&#x5728;&#x6B7B;&#x5FAA;&#x73AF;&#x4E2D;&#x8C03;&#x7528;nativePollOnce&#x65B9;&#x6CD5;&#xFF0C;&#x76F4;&#x89C9;&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x8BE5;&#x65B9;&#x6CD5;&#x5728;&#x6CA1;&#x6709;&#x65B0;&#x6D88;&#x606F;&#x65F6;&#x4F1A;block&#x3002;&#x5728;android_os_MessageQueue.cpp&#x4E2D;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x8BE5;&#x51FD;&#x6570;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x4E86;Looper::pollOnce()&#x65B9;&#x6CD5;.</p>
<img src="/2016/04/17/handler-research/handler_native_poll_once.png">  
<p>&#x5176;&#x4E2D;&#x5173;&#x952E;&#x4EE3;&#x7801;&#x662F;Looper::pollInner&#xFF0C;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x5206;&#x6790;&#x76F8;&#x5173;&#x91CD;&#x8981;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">    int Looper::pollInner(int timeoutMillis) {</span><br><span class="line">        ... </span><br><span class="line">        // Poll.</span><br><span class="line">        int result = POLL_WAKE;</span><br><span class="line">        mResponses.clear();</span><br><span class="line">        mResponseIndex = 0;</span><br><span class="line"></span><br><span class="line">        // We are about to idle.</span><br><span class="line">        mPolling = true;</span><br><span class="line"></span><br><span class="line">        struct epoll_event eventItems[EPOLL_MAX_EVENTS];</span><br><span class="line">        // &#x5173;&#x952E;&#x4EE3;&#x7801;: &#x7B49;&#x5F85;&#x4E8B;&#x4EF6;&#x5230;&#x8FBE; &#x6216;&#x8005; &#x8D85;&#x65F6;</span><br><span class="line">        int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br><span class="line"></span><br><span class="line">        // No longer idling.</span><br><span class="line">        mPolling = false;</span><br><span class="line"></span><br><span class="line">        // Acquire lock.</span><br><span class="line">        mLock.lock();</span><br><span class="line"></span><br><span class="line">        // Rebuild epoll set if needed.</span><br><span class="line">        if (mEpollRebuildRequired) {</span><br><span class="line">            mEpollRebuildRequired = false;</span><br><span class="line">            rebuildEpollLocked();</span><br><span class="line">            goto Done;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // Check for poll error.</span><br><span class="line">        if (eventCount &lt; 0) {</span><br><span class="line">            if (errno == EINTR) {</span><br><span class="line">                goto Done;</span><br><span class="line">            }</span><br><span class="line">            ALOGW(&quot;Poll failed with an unexpected error: %s&quot;, strerror(errno));</span><br><span class="line">            result = POLL_ERROR;</span><br><span class="line">            goto Done;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // Check for poll timeout.</span><br><span class="line">        if (eventCount == 0) { // 0&#x8868;&#x793A;&#x8D85;&#x65F6;</span><br><span class="line">    #if DEBUG_POLL_AND_WAKE</span><br><span class="line">            ALOGD(&quot;%p ~ pollOnce - timeout&quot;, this);</span><br><span class="line">    #endif</span><br><span class="line">            result = POLL_TIMEOUT;</span><br><span class="line">            goto Done;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // Handle all events.</span><br><span class="line">    #if DEBUG_POLL_AND_WAKE</span><br><span class="line">        ALOGD(&quot;%p ~ pollOnce - handling events from %d fds&quot;, this, eventCount);</span><br><span class="line">    #endif</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; eventCount; i++) {</span><br><span class="line">            int fd = eventItems[i].data.fd;</span><br><span class="line">            uint32_t epollEvents = eventItems[i].events;</span><br><span class="line">            if (fd == mWakeEventFd) { // &#x5982;&#x679C;&#x662F; mWakeEventFd &#x7684;&#x53EF;&#x8BFB;&#x4E8B;&#x4EF6;&#xFF0C;&#x6267;&#x884C; awoke&#x51FD;&#x6570;&#xFF0C;&#x5C31;&#x662F;&#x4ECE; mWakeEventFd&#x8BFB;&#x51FA;&#x6570;&#x636E;</span><br><span class="line">                if (epollEvents &amp; EPOLLIN) {</span><br><span class="line">                    awoken();</span><br><span class="line">                } else {</span><br><span class="line">                    ALOGW(&quot;Ignoring unexpected epoll events 0x%x on wake event fd.&quot;, epollEvents);</span><br><span class="line">                }</span><br><span class="line">            } else {</span><br><span class="line">                ssize_t requestIndex = mRequests.indexOfKey(fd);</span><br><span class="line">                if (requestIndex &gt;= 0) {</span><br><span class="line">                    int events = 0;</span><br><span class="line">                    if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</span><br><span class="line">                    if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</span><br><span class="line">                    if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</span><br><span class="line">                    if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</span><br><span class="line">                    pushResponse(events, mRequests.valueAt(requestIndex));</span><br><span class="line">                } else {</span><br><span class="line">                    ALOGW(&quot;Ignoring unexpected epoll events 0x%x on fd %d that is &quot;</span><br><span class="line">                            &quot;no longer registered.&quot;, epollEvents, fd);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    Done: ;</span><br><span class="line"></span><br><span class="line">        // --- &#x5904;&#x7406;Native Message</span><br><span class="line">        // Invoke pending message callbacks.</span><br><span class="line">        mNextMessageUptime = LLONG_MAX;</span><br><span class="line">        while (mMessageEnvelopes.size() != 0) {</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // Release lock.</span><br><span class="line">        mLock.unlock();</span><br><span class="line"></span><br><span class="line">        // --- &#x5904;&#x7406;&#x5E26;&#x6709;Callback&#x7684;Response&#x4E8B;&#x4EF6;</span><br><span class="line">        // Invoke all response callbacks.</span><br><span class="line">        for (size_t i = 0; i &lt; mResponses.size(); i++) {</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line">        return result; // &#x6D88;&#x606F;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x662F;&#x5148;&#x5904;&#x7406;Native Message&#xFF0C;&#x518D;&#x5904;&#x7406;Native Request&#xFF0C;&#x6700;&#x540E;&#x5904;&#x7406;Java    </span><br><span class="line">                       // Message&#x3002;&#x6240;&#x4EE5;&#x6709;&#x65F6;&#x5019;&#x4E0A;&#x5C42;&#x6D88;&#x606F;&#x5F88;&#x5C11;&#xFF0C;&#x4F46;&#x76F8;&#x5E94;&#x65F6;&#x95F4;&#x5374;&#x6BD4;&#x8F83;&#x957F;&#x3002;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>2.&#x6267;&#x884C;IdleHandler&#x6D88;&#x606F;&#x3002;&#x5F53;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4E3A;&#x7A7A;&#x6216;&#x8005;&#x672A;&#x5230;&#x6D88;&#x606F;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x6267;&#x884C;IdleHandler&#x6D88;&#x606F;&#xFF0C;&#x7136;&#x540E;&#x963B;&#x585E;&#x7B49;&#x5F85;&#x6D88;&#x606F;&#x5230;&#x8FBE;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x6216;&#x65B0;&#x6D88;&#x606F;&#x5230;&#x8FBE;&#x3002;&#x901A;&#x5E38;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x8FD9;&#x4E9B;&#x573A;&#x666F;:&#x8981;&#x6267;&#x884C;&#x4F46;&#x662F;&#x4E0D;&#x77E5;&#x6307;&#x5B9A;&#x591A;&#x5C11;&#x5EF6;&#x8FDF;&#x65F6;&#x95F4;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x597D;&#x50CF;Activity&#x7684;onStop()&#x51FD;&#x6570;&#x5C31;&#x662F;&#x653E;&#x5728;&#x8FD9;&#x91CC;&#x9762;&#x6267;&#x884C;&#x7684;&#x3002;&#x4F7F;&#x7528;demo&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Looper.myQueue().addIdleHandler(new MessageQueue.IdleHandler() {</span><br><span class="line">            /**</span><br><span class="line">             * &#x8FD4;&#x56DE;&#x503C;boolean&#x8868;&#x793A;needKeep</span><br><span class="line">             * true&#xFF0C;&#x8868;&#x793A;&#x8981;&#x4FDD;&#x7559;&#x4FDD;&#x7559;&#xFF0C;&#x4E0D;&#x79FB;&#x9664;&#x8FD9;&#x4E2A;idleHandler&#xFF0C;&#x53EF;&#x4EE5;&#x53CD;&#x590D;&#x6267;&#x884C;</span><br><span class="line">             * false&#x4EE3;&#x8868;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x4E4B;&#x540E;&#x5C31;&#x79FB;&#x9664;&#x8FD9;&#x4E2A;idleHandler, &#x4E5F;&#x5C31;&#x662F;&#x53EA;&#x6267;&#x884C;&#x4E00;&#x6B21;</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            public boolean queueIdle() {</span><br><span class="line">                // todo</span><br><span class="line">                return false;</span><br><span class="line">            }</span><br><span class="line">        });</span><br></pre></td></tr></table></figure></p>
<h2 id="handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;"><a href="#Handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;" class="headerlink" title="Handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;"></a>Handler&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x95EE;&#x9898;</h2><p>&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x5728;Activity&#x4E2D;&#x521B;&#x5EFA;Handler&#x65F6;&#xFF0C;Lint&#x4F1A;&#x63D0;&#x793A;AndroidLintHandlerLeak&#xFF0C;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x5982;&#x4E0B;:</p>
<blockquote>
<p>Since this Handler is declared as an inner class, it may prevent the outer class from being garbage collected. If the Handler is using a Looper or MessageQueue for a thread other than the main thread, then there is no issue. If the Handler is using the Looper or MessageQueue of the main thread, you need to fix your Handler declaration, as follows: Declare the Handler as a static class; In the outer class, instantiate a WeakReference to the outer class and pass this object to your Handler when you instantiate the Handler; Make all references to members of the outer class using the WeakReference object.</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x9759;&#x6001;&#x5185;&#x90E8;&#x7C7B; + &#x5F31;&#x5F15;&#x7528;&#x7684;&#x65B9;&#x6848;&#xFF1B;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x65B9;&#x6848;&#x662F;:onDestroy&#x4E2D;&#x624B;&#x52A8;&#x6E05;&#x9664;&#x6389;&#x6240;&#x6709;Messages<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mHandler.removeCallbacksAndMessages(null);</span><br></pre></td></tr></table></figure></p>
<h2 id="&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;</h2><p>&#x597D;&#x50CF;&#x4E0A;&#x8FF0;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x90FD;&#x4E0D;&#x591F;&#x7B80;&#x6D01;&#xFF0C;&#x4ECE;GitHub&#x53D1;&#x73B0;&#x4E00;&#x79CD;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;(<a href="https://github.com/badoo/android-weak-handler" target="_blank" rel="noopener">https://github.com/badoo/android-weak-handler</a>)&#xFF0C;&#x5B9E;&#x73B0;&#x6BD4;&#x8F83;&#x5DE7;&#x5999;&#xFF1B;&#x5176;&#x539F;&#x7406;&#x5C31;&#x662F;&#x628A;Handler&#x5C01;&#x88C5;&#x6210;WeakHandler&#xFF0C;&#x5176;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x6709;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x5185;&#x90E8;&#x7C7B;ExecHandler&#xFF0C;WeakHanlder&#x7684;&#x8C03;&#x7528;&#x5B9E;&#x9645;&#x4E0A;&#x90FD;&#x662F;&#x8C03;&#x7528;ExecHandler&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5173;&#x952E;&#x662F;&#x6240;&#x6709;Callback&#x90FD;&#x662F;WeakReference&#xFF0C;&#x4F46;&#x540C;&#x65F6;&#x5FC5;&#x987B;&#x505A;&#x5230;keep callback in memory&#xFF0C;&#x5426;&#x5219;GC&#x65F6;&#x4F1A;&#x628A;&#x5F31;&#x5F15;&#x7528;&#x7684;&#x56DE;&#x8C03;&#x7ED9;&#x56DE;&#x6536;&#x4E86;&#x3002;  </p>
<ul>
<li>sendXXXMessage:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private final Handler.Callback mCallback; // hard reference to Callback. We need to keep callback in memory</span><br><span class="line">private final ExecHandler mExec;</span><br><span class="line"></span><br><span class="line">public WeakHandler(@Nullable Handler.Callback callback) {</span><br><span class="line">    mCallback = callback; // Hard referencing body</span><br><span class="line">    mExec = new ExecHandler(new WeakReference&lt;&gt;(callback)); // Weak referencing inside ExecHandler</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">private static class ExecHandler extends Handler {</span><br><span class="line">    private final WeakReference&lt;Handler.Callback&gt; mCallback;</span><br><span class="line">    ...</span><br><span class="line">    ExecHandler(WeakReference&lt;Handler.Callback&gt; callback) {</span><br><span class="line">        mCallback = callback;</span><br><span class="line">    }</span><br><span class="line">    ....</span><br><span class="line">    @Override</span><br><span class="line">    public void handleMessage(@NonNull Message msg) {</span><br><span class="line">        if (mCallback == null) {</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        final Handler.Callback callback = mCallback.get();</span><br><span class="line">        if (callback == null) { // Already disposed</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        callback.handleMessage(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public final boolean sendMessage(Message msg) {</span><br><span class="line">        return mExec.sendMessage(msg);</span><br><span class="line">}</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>post(Runnable):</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> final ChainedRef mRunnables = new ChainedRef(mLock, null);</span><br><span class="line"></span><br><span class="line"> static class ChainedRef { // &#x8FD9;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x8BBE;&#x8BA1;&#x6BD4;&#x8F83;&#x5DE7;&#x5999;</span><br><span class="line">         @Nullable</span><br><span class="line">         ChainedRef next;</span><br><span class="line">         @Nullable</span><br><span class="line">         ChainedRef prev;</span><br><span class="line">         @NonNull</span><br><span class="line">         final Runnable runnable;</span><br><span class="line">         @NonNull</span><br><span class="line">         final WeakRunnable wrapper;</span><br><span class="line">         ...</span><br><span class="line">         public ChainedRef(@NonNull Lock lock, @NonNull Runnable r) {</span><br><span class="line">             this.runnable = r;</span><br><span class="line">             this.lock = lock;</span><br><span class="line">             this.wrapper = new WeakRunnable(new WeakReference&lt;&gt;(r), new WeakReference&lt;&gt;(this));</span><br><span class="line">         }</span><br><span class="line">         ...</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> static class WeakRunnable implements Runnable {</span><br><span class="line">     private final WeakReference&lt;Runnable&gt; mDelegate;</span><br><span class="line">     private final WeakReference&lt;ChainedRef&gt; mReference;</span><br><span class="line"></span><br><span class="line">     WeakRunnable(WeakReference&lt;Runnable&gt; delegate, WeakReference&lt;ChainedRef&gt; reference) {</span><br><span class="line">         mDelegate = delegate;</span><br><span class="line">         mReference = reference;</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line">     @Override</span><br><span class="line">     public void run() {</span><br><span class="line">         final Runnable delegate = mDelegate.get();</span><br><span class="line">         final ChainedRef reference = mReference.get();</span><br><span class="line">         if (reference != null) {</span><br><span class="line">             reference.remove();</span><br><span class="line">         }</span><br><span class="line">         if (delegate != null) {</span><br><span class="line">             delegate.run();</span><br><span class="line">         }</span><br><span class="line">     }</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line">private WeakRunnable wrapRunnable(@NonNull Runnable r) {</span><br><span class="line">     //noinspection ConstantConditions</span><br><span class="line">     if (r == null) {</span><br><span class="line">         throw new NullPointerException(&quot;Runnable can&apos;t be null&quot;);</span><br><span class="line">     }</span><br><span class="line">     final ChainedRef hardRef = new ChainedRef(mLock, r);</span><br><span class="line">     mRunnables.insertAfter(hardRef);</span><br><span class="line">     return hardRef.wrapper;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> public final boolean post(@NonNull Runnable r) {</span><br><span class="line">     return mExec.post(wrapRunnable(r));</span><br><span class="line"> }</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<h2 id="&#x53C2;&#x8003;"><a href="#&#x53C2;&#x8003;" class="headerlink" title="&#x53C2;&#x8003;"></a>&#x53C2;&#x8003;</h2><p>[1] <a href="http://developer.android.com/intl/zh-cn/reference/android/os/Handler.html" target="_blank" rel="noopener">http://developer.android.com/intl/zh-cn/reference/android/os/Handler.html</a><br>[2] <a href="http://www.69900.com.cn/a34140974/article/details/50638089" target="_blank" rel="noopener">http://www.69900.com.cn/a34140974/article/details/50638089</a><br>[3] <a href="http://gityuan.com/2015/12/27/handler-message-native/" target="_blank" rel="noopener">http://gityuan.com/2015/12/27/handler-message-native/</a><br>[4] <a href="https://github.com/badoo/android-weak-handler" target="_blank" rel="noopener">https://github.com/badoo/android-weak-handler</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/08/java-tcp-ip-socket-program-note-0/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          《Java TCP/IP Socket编程》读书笔记(上)
        
      </div>
    </a>
  
  
    <a href="/2016/04/17/eventbus/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">深入分析Android EventBus组件</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>








</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 andrewlcgu
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>


<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83438834-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>